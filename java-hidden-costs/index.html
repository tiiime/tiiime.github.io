<!DOCTYPE html>
<html>
  
<head>
  <meta charset="utf-8">
  <meta name="author" content="tiiime" />
  
  
  <title>[翻译] Java Hidden Costs | 技不如人，甘拜下风</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="translate,java," />
  

  
  <meta name="description" content="invoker">

  
    <link rel="alternate" href="/atom.xml" title="技不如人，甘拜下风" type="application/atom+xml">
  

  
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.11.1/dist/av-min.js" async></script>
  

  
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
  

  

  

  <script>
  // theme-ad's config script
  // it can be used in every script
  
  window.AD_CONFIG = {
    leancloud: {"appid":"Hyq9wkH495DgNHWhDQCOfQSp-gzGzoHsz","appkey":"WaR7nrzhliHj9aVwdQzkdlGd","comment":false,"count":true},
    welcome: {"enable":false,"interval":30},
    start_time: "2015-01-07",
    passwords: [],
    is_post: true,
    lock: false,
    author: "tiiime",
    share: {"twitter":false,"facebook":false,"weibo":false,"qq":false,"wechat":false},
    mathjax: true,
    page_type: "",
    root: "/"
  };
</script>

  
<script src="/vendor/sha256.min.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/index.js"></script>
<script src="/vendor/qrcode.min.js"></script>


  

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  
<link rel="stylesheet" href="/css/index.css">
<link rel="stylesheet" href="/styles/components/highlight/highlight.css">


  
<meta name="generator" content="Hexo 5.4.0"></head>
  <body>
    <header class="site-header">
  <div class="site-header-brand">
    
      <span class="site-header-brand-title">
        <a href="/">invoker</a>
      </span>
    
    
      <span class="site-header-brand-motto"> | 技不如人，甘拜下风</span>
    
  </div>
  <div class="site-header-right">
    <nav class="site-header-navigation">
      
        <a href="/" target="_self">首页</a>
      
        <a href="/archives/" target="_self">归档</a>
      
        <a href="/tags/" target="_self">标签</a>
      
        <a href="/categories/" target="_self">分类</a>
      
    </nav>
    <div class="site-header-btn">
      
        <a href="https://github.com/tiiime/" target="_blank" id="site-github">
          <i class="fa fa-github-alt"></i>
        </a>
      
      <a href="javascript:void(0);" id="site-search">
        <i class="fa fa-search"></i>
      </a>
      <a href="javascript:void(0);" id="site-nav-btn">
        <i class="fa fa-ellipsis-v"></i>
      </a>
    </div>
  </div>
</header>
<nav class="table-content" id="site-nav">
  <div class="table-content-title">
    <span>导航</span>
  </div>
  <div class="table-content-main">
    <ol class="toc">
      
        <li class="toc-item">
          <a href="/" target="_self">
            首页
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/archives/" target="_self">
            归档
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/tags/" target="_self">
            标签
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/categories/" target="_self">
            分类
          </a>
        </li>
      
    </ol>
  </div>
</nav>
<div id="site-process"></div>
    <main>
      
  <div class="passage">
  <div class="passage-meta">
    <span>
      <i class="fa fa-calendar"></i>2017-08-20
    </span>
    
      <span>
        | <a href="/categories/translate/"><i class="fa fa-bookmark"></i>translate</a>
      </span>
    
  </div>
  <h1 class="passage-title">
    [翻译] Java Hidden Costs
  </h1>
  
  <article class="passage-article">
    <p>翻译</p>
<p>随着 Java 8 被引入 Andorid, 我们更要时刻牢记标准库的 API 和语言特性都伴随着额外的性能消耗。虽然我们的设备不断升级，有了更大的内存，更高的运行速度，但是代码对性能的影响仍是至关重要的。360AnDev 的这次分享将会探讨一些 Java 特性的隐式消耗。我们主要关注与第三方库开发者和应用开发者相关的性能优化方法，并介绍相关的测试工具。</p>
<hr>
<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>文章前面并不会介绍优化相关内容，解决办法会在最后部分。以及本文会有大量命令行工具的使用方法，相关资源连接也会文章末尾附上。</p>
<h3 id="Dex-file"><a href="#Dex-file" class="headerlink" title="Dex file"></a>Dex file</h3><p>我们从一个多选题开始，这段代码里有几个方法？0, 1 or 2?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>翻译好累 不翻了…</strong></p>
<p>0 -&gt; 源文件里确实是 0 个<br>1 -&gt; 编译成字节码，查看 class 文件，有自动生成的无参构造函数<br>2 -&gt; 在 Andorid 中，字节码还会被转换成 dex 文件，使用 SDK 里的工具可以查看详细信息</p>
<p><strong>javac</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ echo <span class="string">&quot;class Example &#123;</span></span><br><span class="line"><span class="string">&#125;&quot;</span> &gt; Example.java</span><br><span class="line"></span><br><span class="line">$ javac Example.java</span><br><span class="line"></span><br><span class="line">$ javap Example.class</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">Example();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>dex</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ dx --dex --output=example.dex Example.class</span><br><span class="line"></span><br><span class="line">$ dexdump -f example.dex</span><br><span class="line"></span><br><span class="line">$ dexdump -f example.dex</span><br><span class="line"></span><br><span class="line">Processing <span class="string">&#x27;example.dex&#x27;</span>...</span><br><span class="line">Opened <span class="string">&#x27;example.dex&#x27;</span>, DEX version <span class="string">&#x27;035&#x27;</span></span><br><span class="line">DEX file header:</span><br><span class="line">magic               : <span class="string">&#x27;dex\n035\0&#x27;</span></span><br><span class="line">checksum            : 53c72da5</span><br><span class="line">...</span><br><span class="line">field_ids_off       : <span class="number">0</span> (<span class="number">0x000000</span>)</span><br><span class="line">method_ids_size     : <span class="number">2</span>	&lt;--------------------------注意这里</span><br><span class="line">method_ids_off      : <span class="number">156</span> (<span class="number">0x00009c</span>)</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>也就是下面这两个方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Example &lt;init&gt;()</span><br><span class="line">java.lang.Object &lt;init&gt;()</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="Java-内部类"><a href="#Java-内部类" class="headerlink" title="Java 内部类"></a>Java 内部类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// ItemsView.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemsView</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemsAdapter</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ javac ItemsView.java</span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">ItemsView.class</span><br><span class="line">ItemsView.java</span><br><span class="line">ItemsView$ItemsAdapter.class</span><br></pre></td></tr></table></figure>
<p>ItemsView 编译后生成两个单独的类文件，由此可见其在 Java 中并没有真正的嵌套。</p>
<p>使用 <code>javap</code> 指令查看，<code>ItemsView.class</code> 中没有任何关于其内部类的信息。另一个值得注意的是虽然内部类 <code>ItemsAdapter</code> 在源文件中被声明为 <code>private</code> ，但在其类文件中却不是私有的，而是默认的 package 访问权限。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  Compiled from &quot;ItemsView.java&quot;</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemsView</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ItemsView</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Compiled from &quot;ItemsView.java&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemsView</span>$<span class="title">ItemsAdapter</span> </span>&#123;</span><br><span class="line">    ItemsView$ItemsAdapter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看起来内部类只是以一种更高效的方式生成了两个处于同一包名下彼此相邻的类文件。</p>
<p><strong>Ps: 我编出来和他说的不一样啊…</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">java version <span class="string">&quot;1.8.0_121&quot;</span></span><br><span class="line">Java(TM) <span class="function">SE Runtime <span class="title">Environment</span> <span class="params">(build <span class="number">1.8</span><span class="number">.0_121</span>-b13)</span></span></span><br><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server <span class="title">VM</span> <span class="params">(build <span class="number">25.121</span>-b13, mixed mode)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">$ javac ItemsView.java -source 1.7 -target 1.7</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">//  Compiled from &quot;ItemsView.java&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> class ItemsView </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ItemsView</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Compiled from &quot;ItemsView.java&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemsView</span>$<span class="title">ItemsAdapter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ItemsView <span class="keyword">this</span>$<span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续上面的，在我们的假设中嵌套类只是生成两个类，但下面两段代码又引出新的问题。</p>
<p><strong>Compile Ok</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemsView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">displayText</span><span class="params">(String item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>; <span class="comment">// TODO</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemsAdapter</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">bindItem</span><span class="params">(TextView tv, String item)</span> </span>&#123;</span><br><span class="line">            tv.setText(ItemsView.displayText(item));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><strong>Compile Error</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ItemsView.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemsView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">displayText</span><span class="params">(String item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>; <span class="comment">// TODO</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ItemsView$ItemsAdapter.java</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemsView</span>$<span class="title">ItemsAdapter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bindItem</span><span class="params">(TextView tv, String item)</span> </span>&#123;</span><br><span class="line">        tv.setText(ItemsView.displayText(item));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>反编译看下编译成功的结果，又出来一个我们没写的方法。也就是说只要在刚才编译失败的那个分离版本中也写上这么一个方法，编译就没问题了。表面上看起来没什么，但这个方法是实实在在的加到你的方法数上的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ javap -p ItemsView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemsView</span> </span>&#123;</span><br><span class="line">    ItemsView();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> java.lang.<span class="function">String <span class="title">displayText</span><span class="params">(…)</span></span>;</span><br><span class="line">    <span class="keyword">static</span> java.lang.String access$<span class="number">000</span>(…);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="More-Dex"><a href="#More-Dex" class="headerlink" title="More Dex"></a>More Dex</h3><p>这东西不光在 <code>javac</code> 里有影响，你把它转成 dex 也是这样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ dx --dex --output=example.dex *.class</span><br><span class="line"></span><br><span class="line">$ dex-method-list example.dex</span><br><span class="line"></span><br><span class="line">ItemsView &lt;init&gt;()</span><br><span class="line">ItemsView access$<span class="number">000</span>(String) → <span class="function">String</span></span><br><span class="line"><span class="function">ItemsView <span class="title">displayText</span><span class="params">(String)</span> → String</span></span><br><span class="line"><span class="function">ItemsView$ItemsAdapter &lt;init&gt;<span class="params">(ItemsView)</span></span></span><br><span class="line"><span class="function">ItemsView$ItemsAdapter <span class="title">bindItem</span><span class="params">(TextView, String)</span></span></span><br><span class="line"><span class="function">android.widget.TextView <span class="title">setText</span><span class="params">(CharSequence)</span></span></span><br><span class="line"><span class="function">java.lang.Object &lt;init&gt;<span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>那么 <strong>Jack</strong> compiler 呢？还是一样，只不过不叫 <code>access</code> 改叫 <code>-wrap0</code> 了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ java -jar android-sdk/build-tools/<span class="number">24.0</span><span class="number">.1</span>/jack.jar \</span><br><span class="line">        -cp android-sdk/platforms/android-<span class="number">24</span>/android.jar \</span><br><span class="line">        --output-dex . \</span><br><span class="line">        ItemsView.java</span><br><span class="line"></span><br><span class="line">$ dex-method-list classes.dex</span><br><span class="line"></span><br><span class="line">ItemsView -wrap0(String) → String</span><br><span class="line">ItemsView &lt;init&gt;()</span><br><span class="line"><span class="function">ItemsView <span class="title">displayText</span><span class="params">(String)</span> → String</span></span><br><span class="line"><span class="function">ItemsView$ItemsAdapter &lt;init&gt;<span class="params">(ItemsView)</span></span></span><br><span class="line"><span class="function">ItemsView$ItemsAdapter <span class="title">bindItem</span><span class="params">(TextView, String)</span></span></span><br><span class="line"><span class="function">android.widget.TextView <span class="title">setText</span><span class="params">(CharSequence)</span></span></span><br><span class="line"><span class="function">java.lang.Object &lt;init&gt;<span class="params">()</span></span></span><br></pre></td></tr></table></figure><br>我们还有 <a target="_blank" rel="noopener" href="https://developer.android.com/studio/build/shrink-code.html">ProGuard</a> 不是，能不能搞定这个方法呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ echo <span class="string">&quot;-dontobfuscate</span></span><br><span class="line"><span class="string">-keep class ItemsView$ItemsAdapter &#123; void bindItem(...); &#125;</span></span><br><span class="line"><span class="string">&quot;</span> &gt; rules.txt</span><br><span class="line"></span><br><span class="line">$ java -jar proguard-base-<span class="number">5.2</span><span class="number">.1</span>.jar \</span><br><span class="line">    -include rules.txt \</span><br><span class="line">    -injars . \</span><br><span class="line">    -outjars example-proguard.jar \</span><br><span class="line">    -libraryjars android-sdk/platforms/android-<span class="number">24</span>/android.jar</span><br><span class="line"></span><br><span class="line">$ dex-method-list example-proguard.jar</span><br><span class="line"></span><br><span class="line">ItemsView access$<span class="number">000</span>(String) → <span class="function">String</span></span><br><span class="line"><span class="function">ItemsView$ItemsAdapter <span class="title">bindItem</span><span class="params">(TextView, String)</span></span></span><br><span class="line"><span class="function">android.widget.TextView <span class="title">setText</span><span class="params">(CharSequence)</span></span></span><br></pre></td></tr></table></figure><br>构造函数因为没使用被移除了，但是实际使用时还是会用到他们，所以我们这里手动保留一下。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ dex-method-list example-proguard.jar</span><br><span class="line"></span><br><span class="line">ItemsView &lt;init&gt;()</span><br><span class="line">ItemsView access$<span class="number">000</span>(String) → String</span><br><span class="line">ItemsView$ItemsAdapter &lt;init&gt;(ItemsView)</span><br><span class="line"><span class="function">ItemsView$ItemsAdapter <span class="title">bindItem</span><span class="params">(TextView, String)</span></span></span><br><span class="line"><span class="function">android.widget.TextView <span class="title">setText</span><span class="params">(CharSequence)</span></span></span><br><span class="line"><span class="function">java.lang.Object &lt;init&gt;<span class="params">()</span></span></span><br></pre></td></tr></table></figure><br>最终结果，<code>access</code>方法仍然存在，但是 <code>displayText</code> 消失了。发生了什么？解压 Proguard 生成的 jar 文件，使用 javap 查看 class 文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ unzip example-proguard.jar</span><br><span class="line"></span><br><span class="line">$ javap -c ItemsView</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemsView</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> java.lang.String access$<span class="number">000</span>(java.lang.String);</span><br><span class="line">        Code:</span><br><span class="line">            <span class="number">0</span>: ldc #<span class="number">1</span> <span class="comment">// String &quot;&quot;</span></span><br><span class="line">            <span class="number">2</span>: areturn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 是因为没有其他位置使用这个方法， Proguard 对 displayText 进行了优化。可以见得 Proguard 在这里确实有那么一点用处，不过对一个简单的 demo 起效并不足以证明。你可能不以为然，觉得内部类的影响没什么大不了的，那我们下面接着说匿名内部类。</p>
<h3 id="匿名内部类"><a href="#匿名内部类" class="headerlink" title="匿名内部类"></a>匿名内部类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(state);</span><br><span class="line"></span><br><span class="line">        setContentView(R.layout.whatever);</span><br><span class="line">        findViewById(R.id.button).setOnClickListener(</span><br><span class="line">            <span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                    <span class="comment">// Hello!</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这东西我们常用，匿名内部类其实就是嵌套类，只不过他没有名字。如果你访问了一个外部类的 private 方法，他就会对应生成 access 方法，访问字段也是这样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(state);</span><br><span class="line"></span><br><span class="line">        setContentView(R.layout.whatever);</span><br><span class="line">        findViewById(R.id.button).setOnClickListener(</span><br><span class="line">            <span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                    count = <span class="number">0</span>;</span><br><span class="line">                    ++count;</span><br><span class="line">                    --count;</span><br><span class="line">                    count++;</span><br><span class="line">                    count--;</span><br><span class="line">                    Log.d(<span class="string">&quot;Count&quot;</span>, <span class="string">&quot;= &quot;</span> + count);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你猜上面这段代码会生成多少个 access 方法呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ javac -bootclasspath android-sdk/platforms/android-<span class="number">24</span>/android.jar \</span><br><span class="line">MyActivity.java</span><br><span class="line"></span><br><span class="line">$ javap MyActivity</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Activity</span> </span>&#123;</span><br><span class="line">    MyActivity();</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(android.os.Bundle)</span></span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> access$<span class="number">002</span>(MyActivity, <span class="keyword">int</span>); <span class="comment">// count = 0    write</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> access$<span class="number">004</span>(MyActivity);        <span class="comment">// ++count         preinc</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> access$<span class="number">006</span>(MyActivity);        <span class="comment">// --count         predec</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> access$008(MyActivity);        <span class="comment">// count++         postinc</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> access$<span class="number">010</span>(MyActivity);        <span class="comment">// count--         postdec</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> access$<span class="number">000</span>(MyActivity);        <span class="comment">// count         read</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>可想而知，如果一个 Activity 或是 Fragment 里有几个这样的 listener，那方法数还不得爆炸。</p>
<h3 id="现实世界"><a href="#现实世界" class="headerlink" title="现实世界"></a>现实世界</h3><p>我们来看看你手机里的应用吧，先把你安装的 APK 都拷贝出来<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell mkdir /mnt/sdcard/apks</span><br><span class="line"></span><br><span class="line">$ adb shell cmd <span class="keyword">package</span> list packages -<span class="number">3</span> -f \</span><br><span class="line">| cut -c <span class="number">9</span>- \</span><br><span class="line">| sed <span class="string">&#x27;s|=| /mnt/sdcard/apks/|&#x27;</span> \</span><br><span class="line">| xargs -t -L1 adb shell cp</span><br><span class="line"></span><br><span class="line">$ adb pull /mnt/sdkcard/apks</span><br></pre></td></tr></table></figure></p>
<p>然后用 <code>dex-method-list</code>  和 <code>grep</code> 统计下方法数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash                                                 accessors.sh</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">METHODS=$(dex-method-list $<span class="number">1</span> | \grep <span class="string">&#x27;access\$&#x27;</span>)</span><br><span class="line">ACCESSORS=$(echo <span class="string">&quot;$METHODS&quot;</span> | wc -l | xargs)</span><br><span class="line">METHOD_AND_READ=$(echo <span class="string">&quot;$METHODS&quot;</span> | egrep <span class="string">&#x27;access\$\d+00\(&#x27;</span> | wc -l | xargs)</span><br><span class="line">WRITE=$(echo <span class="string">&quot;$METHODS&quot;</span> | egrep <span class="string">&#x27;access\$\d+02\(&#x27;</span> | wc -l | xargs)</span><br><span class="line">PREINC=$(echo <span class="string">&quot;$METHODS&quot;</span> | egrep <span class="string">&#x27;access\$\d+04\(&#x27;</span> | wc -l | xargs)</span><br><span class="line">PREDEC=$(echo <span class="string">&quot;$METHODS&quot;</span> | egrep <span class="string">&#x27;access\$\d+06\(&#x27;</span> | wc -l | xargs)</span><br><span class="line">POSTINC=$(echo <span class="string">&quot;$METHODS&quot;</span> | egrep <span class="string">&#x27;access\$\d+08\(&#x27;</span> | wc -l | xargs)</span><br><span class="line">POSTDEC=$(echo <span class="string">&quot;$METHODS&quot;</span> | egrep <span class="string">&#x27;access\$\d+10\(&#x27;</span> | wc -l | xargs)</span><br><span class="line">OTHER=$(($ACCESSORS - $METHOD_AND_READ - $WRITE - $PREINC - $PREDEC - $POSTINC - $POSTDEC))</span><br><span class="line"></span><br><span class="line">NAME=$(basename $<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">echo -e <span class="string">&quot;$NAME\t$ACCESSORS\t$READ\t$WRITE\t$PREINC\t$PREDEC\t$POSTINC\t$POSTDEC\t$OTHER&quot;</span></span><br></pre></td></tr></table></figure></p>
<p>最后使用这个脚本遍历 pull 出来的 APK<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ column -t -s $<span class="string">&#x27;\t&#x27;</span> \</span><br><span class="line">&lt;(echo -e <span class="string">&quot;NAME\tTOTAL\tMETHOD/READ\tWRITE\tPREINC\tPREDEC\tPOSTINC\tPOSTDEC\tOTHER&quot;</span> \</span><br><span class="line">&amp;&amp; find apks -type f | \</span><br><span class="line">xargs -L1 ./accessors.sh | \</span><br><span class="line">sort -k2,2nr)</span><br></pre></td></tr></table></figure><br>相信结果一定令人印象深刻。</p>
<p>解决办法也相当简单，不使用 private 或者使用 package 访问权限。使用 IntelliGate 可以对代码进行检测，并将问题代码高亮，有效的提示你注意这个问题。 </p>
<h3 id="Synthetic-方法"><a href="#Synthetic-方法" class="headerlink" title="Synthetic 方法"></a>Synthetic 方法</h3><p>Synthetic 方法是自动生成的。而且上面 accessor 并不是唯一的例子，泛型也是其中之一。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Callbacks.java</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Callback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">call</span><span class="params">(T value)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringCallback</span> <span class="keyword">implements</span> <span class="title">Callback</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>假设我们有一个方法接收一个泛型值，编译后可以发现，这个方法被转换成了两个。一个是我们使用的，另一个的参数却是 Object，这就是类型擦除。我们不得不为它生成方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ javap -c StringCallback</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringCallback</span> <span class="keyword">implements</span> <span class="title">Callback</span>&lt;<span class="title">java</span>.<span class="title">lang</span>.<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    StringCallback();</span><br><span class="line">        Code: &lt;removed&gt;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(java.lang.String)</span></span>;</span><br><span class="line">        Code: &lt;removed&gt;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(java.lang.Object)</span></span>;</span><br><span class="line">        Code:</span><br><span class="line">        <span class="number">0</span>: aload_0</span><br><span class="line">        <span class="number">1</span>: aload_1</span><br><span class="line">        <span class="number">2</span>: checkcast #<span class="number">4</span> <span class="comment">// class java/lang/String</span></span><br><span class="line">        <span class="number">5</span>: invokevirtual #<span class="number">5</span> <span class="comment">// Method call:(Ljava/lang/String;)V</span></span><br><span class="line">        <span class="number">8</span>: <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看生成的方法，只是做了类型转换，然后调用实际方法。对于返回值的泛型也是这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ javac -bootclasspath android-sdk/platforms/android-<span class="number">24</span>/android.jar \</span><br><span class="line">    Example.java</span><br><span class="line"></span><br><span class="line">$ javap -c ViewProvider</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewProvider</span> <span class="keyword">implements</span> <span class="title">Provider</span>&lt;<span class="title">android</span>.<span class="title">view</span>.<span class="title">View</span>&gt; </span>&#123;</span><br><span class="line">    ViewProvider();</span><br><span class="line">        Code: &lt;removed&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> android.view.<span class="function">View <span class="title">get</span><span class="params">(android.content.Context)</span></span>;</span><br><span class="line">        Code: &lt;removed&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> java.lang.<span class="function">Object <span class="title">get</span><span class="params">(android.content.Context)</span></span>;</span><br><span class="line">        Code:</span><br><span class="line">            <span class="number">0</span>: aload_0</span><br><span class="line">            <span class="number">1</span>: aload_1</span><br><span class="line">            <span class="number">2</span>: invokevirtual #<span class="number">4</span> <span class="comment">// Method get:(…)Landroid/view/View;</span></span><br><span class="line">            <span class="number">5</span>: areturn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>许多人还没注意到 Java 的一个特性<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewProvider</span> <span class="keyword">implements</span> <span class="title">Provider</span>&lt;<span class="title">View</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> View <span class="title">get</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> View(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextViewProvider</span> <span class="keyword">extends</span> <span class="title">ViewProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> TextView <span class="title">get</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TextView(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>你可以将这个返回值限定为一个更具体的类型。这被称为 covariant(协变)返回类型。返回值并不是强制的要像例子里那样实现一个 interface。这个 base class 可以是 interface 也可以是其他任何东西。你可以将 base class 中任何一个方法的返回值类型变成一个更为特定的类。</p>
<p>常用于你在其他类中使用这个方法时，想调用 <code>get</code> 方法获取某个具体的实现类型，而不是更宽广的基类，比如这个例子中的 <code>View</code>。将返回值类型限定为 <code>TextView</code> 是被允许的。</p>
<h3 id="Covariant-return-type"><a href="#Covariant-return-type" class="headerlink" title="Covariant return type"></a>Covariant return type</h3><p>代价是什么？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ javap TextViewProvider</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextViewProvider</span> <span class="keyword">extends</span> <span class="title">ViewProvider</span> </span>&#123;</span><br><span class="line">    TextViewProvider();</span><br><span class="line">    <span class="keyword">public</span> android.widget.<span class="function">TextView <span class="title">get</span><span class="params">(android.content.Context)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> android.view.<span class="function">View <span class="title">get</span><span class="params">(android.content.Context)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> java.lang.<span class="function">Object <span class="title">get</span><span class="params">(android.content.Context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>又出现一个方法。在当前的例子中，它既是一个泛型也是个 covariant 返回值类型。我们把原有的一个方法变成了仨，然而并没有做啥有意义的事。下面的 python 脚本可以用来检测：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">list = subprocess.check_output([<span class="string">&quot;dex-method-list&quot;</span>, sys.argv[<span class="number">1</span>]])</span><br><span class="line"></span><br><span class="line">class_info_by_name = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item in list.split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">    first_space = item.find(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    open_paren = item.find(<span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">    close_paren = item.find(<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">    last_space = item.rfind(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    class_name = item[<span class="number">0</span>:first_space]</span><br><span class="line">    method_name = item[first_space + <span class="number">1</span>:open_paren]</span><br><span class="line">    params = [param <span class="keyword">for</span> param in item[open_paren + <span class="number">1</span>:close_paren].split(<span class="string">&#x27;, &#x27;</span>) <span class="function"><span class="keyword">if</span> <span class="title">len</span><span class="params">(param)</span> &gt; 0]</span></span><br><span class="line"><span class="function">    return_type </span>= item[last_space + <span class="number">1</span>:]</span><br><span class="line">    <span class="keyword">if</span> last_space &lt; close_paren:</span><br><span class="line">        return_type = <span class="string">&#x27;void&#x27;</span></span><br><span class="line"></span><br><span class="line">    # print class_name, method_name, params, return_type</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> class_name not in class_info_by_name:</span><br><span class="line">        class_info_by_name[class_name] = &#123;&#125;</span><br><span class="line">    class_info = class_info_by_name[class_name]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> method_name not in class_info:</span><br><span class="line">        class_info[method_name] = []</span><br><span class="line">    method_info_by_name = class_info[method_name]</span><br><span class="line"></span><br><span class="line">    method_info_by_name.append(&#123;</span><br><span class="line">        <span class="string">&#x27;params&#x27;</span>: params,</span><br><span class="line">        <span class="string">&#x27;return&#x27;</span>: return_type</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> class_name, class_info in class_info_by_name.items():</span><br><span class="line">    <span class="keyword">for</span> method_name, method_info_by_name in class_info.items():</span><br><span class="line">        <span class="keyword">for</span> method_info in method_info_by_name:</span><br><span class="line">            <span class="keyword">for</span> other_method_info in method_info_by_name:</span><br><span class="line">                <span class="keyword">if</span> method_info == other_method_info:</span><br><span class="line">                    <span class="keyword">continue</span> # Do not compare against self.</span><br><span class="line">                params = method_info[<span class="string">&#x27;params&#x27;</span>]</span><br><span class="line">                other_params = other_method_info[<span class="string">&#x27;params&#x27;</span>]</span><br><span class="line">                <span class="function"><span class="keyword">if</span> <span class="title">len</span><span class="params">(params)</span> !</span>= len(other_params):</span><br><span class="line">                    <span class="keyword">continue</span> # Do not compare different numbered parameter lists.</span><br><span class="line"></span><br><span class="line">                match = True</span><br><span class="line">                erased = False</span><br><span class="line">                <span class="keyword">for</span> idx, <span class="function">param in <span class="title">enumerate</span><span class="params">(params)</span>:</span></span><br><span class="line"><span class="function">                    other_param </span>= other_params[idx]</span><br><span class="line">                    <span class="keyword">if</span> param != <span class="string">&#x27;Object&#x27;</span> and not param[<span class="number">0</span>].islower() and other_param == <span class="string">&#x27;Object&#x27;</span>:</span><br><span class="line">                        erased = True</span><br><span class="line">                    elif param != other_param:</span><br><span class="line">                        match = False</span><br><span class="line"></span><br><span class="line">                return_type = method_info[<span class="string">&#x27;return&#x27;</span>]</span><br><span class="line">                other_return_type = other_method_info[<span class="string">&#x27;return&#x27;</span>]</span><br><span class="line">                <span class="keyword">if</span> return_type != <span class="string">&#x27;Object&#x27;</span> and other_return_type == <span class="string">&#x27;Object&#x27;</span>:</span><br><span class="line">                    erased = True</span><br><span class="line">                elif return_type != other_return_type:</span><br><span class="line">                    match = False</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> match and erased:</span><br><span class="line">                    count += <span class="number">1</span></span><br><span class="line">                    # print <span class="string">&quot;FOUND! %s %s %s %s&quot;</span> % (class_name, method_name, params, return_type)</span><br><span class="line">                    # print <span class="string">&quot; %s %s %s %s&quot;</span> % (class_name, method_name, other_params, other_return_type)</span><br><span class="line"></span><br><span class="line">print os.path.basename(sys.argv[<span class="number">1</span>]) + <span class="string">&#x27;\t&#x27;</span> + str(count)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>想知道这个 case 在应用中有多么普遍，我们会像上面一样遍历所有 apk，耗时会有点长。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ column -t -s $<span class="string">&#x27;\t&#x27;</span> \</span><br><span class="line">    &lt;(echo -e <span class="string">&quot;NAME\tERASED&quot;</span> \</span><br><span class="line">        &amp;&amp; find apks -type f | \</span><br><span class="line">            xargs -L1 ./erased.py | \</span><br><span class="line">            sort -k2,2nr)</span><br></pre></td></tr></table></figure><br>大约有小几千。这种情况我们能做的不多，使用 ProGuard 可以剔除那些没被使用的方法，但是如果你在泛型场景中调用过的方法，将不会被移除。</p>
<p>最后的一个关于方法的例子里，我想讲点未来会出现在 Android 开发中的 Java 8 feature。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hi!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        Executor executor = Executors.newSingleThreadExecutor();</span><br><span class="line">        <span class="keyword">final</span> Greeter greeter = <span class="keyword">new</span> Greeter();</span><br><span class="line">        executor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                greeter.sayHi();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们已经使用 retro-lamina 有段日子了。Jack compiler 也实现了类似的功能，为了向后兼容。那么这里的性能消耗和新的语言特性之间有什么关联吗？</p>
<p>接下来就看段代码来说。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hi!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        Executor executor = Executors.newSingleThreadExecutor();</span><br><span class="line">        Greeter greeter = <span class="keyword">new</span> Greeter();</span><br><span class="line">        executor.execute(() -&gt; greeter.sayHi());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 lambda 世界里，只是减少了冗余的代码。实际上还是会创建一个 <code>Runnable</code> ，并且隐含了很多内容。你不必再指定其类型，实现的方法名和参数名。<br>最后，方法引用。因为可以推断出此处不需要接收参数，也不用返回值，我们只要执行这个方法就好，所以可以自动将其转换成 Runnable。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hi!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        Executor executor = Executors.newSingleThreadExecutor();</span><br><span class="line">        Greeter greeter = <span class="keyword">new</span> Greeter();</span><br><span class="line">        executor.execute(greeter::sayHi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="How-much-do-these-cost"><a href="#How-much-do-these-cost" class="headerlink" title="How much do these cost?"></a>How much do these cost?</h3><p>那么他们各自的性能消耗优势怎样？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Retrolambda toolchain</span><br><span class="line"></span><br><span class="line">$ javac *.java</span><br><span class="line"></span><br><span class="line">$ java -Dretrolambda.inputDir=. -Dretrolambda.classpath=. \</span><br><span class="line">    -jar retrolambda.jar</span><br><span class="line"></span><br><span class="line">$ dx --dex --output=example.dex *.class</span><br><span class="line"></span><br><span class="line">$ dex-method-list example.dex</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Jack toolchain </span><br><span class="line"></span><br><span class="line">$ java -jar android-sdk/build-tools/<span class="number">24.0</span><span class="number">.1</span>/jack.jar \</span><br><span class="line">        -cp android-sdk/platforms/android-<span class="number">24</span>/android.jar \</span><br><span class="line">        --output-dex . *.java</span><br><span class="line"></span><br><span class="line">$ dex-method-list classes.dex</span><br></pre></td></tr></table></figure>
<p>Jack’s ，这里没有使用 ProGuard ，也不开启 Jack’s 的 minification ，因为对结果没什么影响。当前这个匿名内部类的例子方法数是 2。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Example$<span class="number">1</span> &lt;init&gt;(Greeter)</span><br><span class="line"><span class="function">Example$1 <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">$ javap -c &#x27;Example$1&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> class Example$1 implements java.lang.Runnable </span>&#123;</span><br><span class="line">    Example$<span class="number">1</span>(Greeter);</span><br><span class="line">        Code: &lt;removed&gt;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">        Code:</span><br><span class="line">        <span class="number">0</span>: aload_0</span><br><span class="line">        <span class="number">1</span>: getfield #<span class="number">1</span> <span class="comment">// Field val$greeter:LGreeter;</span></span><br><span class="line">        <span class="number">4</span>: invokevirtual #<span class="number">3</span> <span class="comment">// Method Greeter.sayHi:()V</span></span><br><span class="line">        <span class="number">7</span>: <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Retrolambda 的旧版本开销比较大，一小段代码就会多生成六七个方法，不过新版本中下降到 4 个。<br>相比之下，多出来两个方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Example lambda$main$<span class="number">0</span>(Greeter)</span><br><span class="line">Example$$Lambda$<span class="number">1</span> &lt;init&gt;(Greeter)</span><br><span class="line">Example$$Lambda$<span class="number">1</span> lambdaFactory$(Greeter) → <span class="function">Runnable</span></span><br><span class="line"><span class="function">Example$$Lambda$1 <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">$ javap -c &#x27;Example$$Lambda$1&#x27;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">final</span> class Example$$Lambda$1 implements java.lang.Runnable </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">        Code:</span><br><span class="line">            <span class="number">0</span>: aload_0</span><br><span class="line">            <span class="number">1</span>: getfield #<span class="number">15</span> <span class="comment">// Field arg$1:LGreeter;</span></span><br><span class="line">            <span class="number">4</span>: invokestatic #<span class="number">21</span> <span class="comment">// Method Example.lambda$main$0:</span></span><br><span class="line">            <span class="number">7</span>: <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>最上面的那个方法就是和 jack 不同的地方。当你用 lambda 定义一段代码时，要有个位置存放这段代码。它没有被编码在定义 lambda 的那段代码的方法内，那会很奇怪，因为他不属于那个方法。必须有一个位置保存这段代码，以便在你请求这段代码时调用。<br>它实际上将 和 runnable 实现的那个很像。run 方法和构造函数仍在，只不过 run 函数没有直接调用 Greeter，而是返回原始类调用那段 lambda 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Example lambda$main$0(Greeter)</span><br><span class="line">Example$$Lambda$1 &lt;init&gt;(Greeter)</span><br><span class="line">Example$$Lambda$1 lambdaFactory$(Greeter) → Runnable</span><br><span class="line">Example$$Lambda$1 run()</span><br></pre></td></tr></table></figure>
<p>retrolambda 也没有直接使用生成类的构造函数来实例化，而是用一个静态工厂方法创建它。Jack 基本和他一样，只不过没有这个静态方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Example -Example_lambda$1(Greeter)</span><br><span class="line">Example &lt;init&gt;()</span><br><span class="line">Example main(String[])</span><br><span class="line">Example run(Runnable)</span><br><span class="line">Example$-void_main_java_lang_String__args_LambdaImpl0 &lt;init&gt;(Greeter)</span><br><span class="line">Example$-void_main_java_lang_String__args_LambdaImpl0 run()</span><br><span class="line">Greeter &lt;init&gt;()</span><br><span class="line">Greeter sayHi()</span><br><span class="line">java.io.PrintStream println(String)</span><br><span class="line">java.lang.Object &lt;init&gt;()</span><br><span class="line">java.lang.Runnable run()</span><br></pre></td></tr></table></figure>
<p>最上面就是需要额外生成的那个方法。<br>访问了一个私有方法的话  retrolambda 和 jack 就不得不生成额外方法，实际上这个方法是由 java 产生的，也就是第四个方法。</p>
<p>Jack 现存一个 bug，会为每一个单独的方法引用生成一个 accessor  方法，希望能够尽快修复。</p>
<h3 id="Lambdas-in-the-wild"><a href="#Lambdas-in-the-wild" class="headerlink" title="Lambdas in the wild"></a>Lambdas in the wild</h3><p>统计 apk 中的情况<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash             lambdas.sh</span></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">ALL=$(dex-method-list $1)</span><br><span class="line"></span><br><span class="line">RL=$(echo &quot;$ALL&quot; | \grep &#x27; lambda\$&#x27; | wc -l | xargs)</span><br><span class="line">JACK=$(echo &quot;$ALL&quot; | \grep &#x27;_lambda\$&#x27; | wc -l | xargs)</span><br><span class="line"></span><br><span class="line">NAME=$(basename $1)</span><br><span class="line"></span><br><span class="line">echo -e &quot;$NAME\t$RL\t$JACK&quot;</span><br></pre></td></tr></table></figure><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> column -t -s $<span class="string">&#x27;\t&#x27;</span> \</span></span><br><span class="line"><span class="bash">    &lt;(<span class="built_in">echo</span> -e <span class="string">&quot;NAME\tRETROLAMBDA\tJACK&quot;</span> \</span></span><br><span class="line"><span class="bash">        &amp;&amp; find apks -<span class="built_in">type</span> f | \</span></span><br><span class="line"><span class="bash">            xargs -L1 ./lambdas.sh | \</span></span><br><span class="line"><span class="bash">            sort -k2,2nr)</span></span><br><span class="line"></span><br><span class="line">NAME                         RETROLAMBDA     JACK</span><br><span class="line">com.squareup.cash             826             0</span><br><span class="line">com.robinhood.android         680             0</span><br><span class="line">com.imdb.mobile             306             0</span><br><span class="line">com.stackexchange.marvin     174             0</span><br><span class="line">com.eventbrite.attendee     53                 0</span><br><span class="line">com.untappdllc.app             53                 0</span><br></pre></td></tr></table></figure><br>显然，使用 lambda 的人还比较少，使用 jack 编译 lambda 的人为 0，再或者他们使用了 ProGuard，lambda 的类名何方法被消除了。</p>
<p>我是因为 65K 方法数的限制才研究的这里，不过实际上这些方法对运行时也会造成影响。 </p>
<h3 id="Collections"><a href="#Collections" class="headerlink" title="Collections"></a>Collections</h3><p>接下来介绍的内容更偏向于运行时， collections 。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;K, V&gt;                ArrayMap&lt;K, V&gt;</span><br><span class="line">HashSet&lt;K, V&gt;                ArraySet&lt;V&gt;</span><br><span class="line">HashMap&lt;Integer, V&gt;            SparseArray&lt;V&gt;</span><br><span class="line">HashMap&lt;Integer, Boolean&gt;    SparseBooleanArray</span><br><span class="line">HashMap&lt;Integer, Integer&gt;    SparseIntArray</span><br><span class="line">HashMap&lt;Integer, Long&gt;        SparseLongArray</span><br><span class="line">HashMap&lt;Long, V&gt;            LongSparseArray&lt;V&gt;</span><br></pre></td></tr></table></figure><br>这是一组对应的集合，相对于 HashMap ， Android 提供的实现有着显著优势。<br>以前常听人说自动装箱，将原始类型转换成对象。Java 对于常用的数字有缓存，但是剩下的就需要每次使用时都重新创建一个对象，这会带来很大的性能消耗。<br>除了上面这点，还有数据寻址和数据的内存布局。<br>如果你看 HashMap 的源码，他用一个 array  来保存 Node。当你进行存取操作时，都要进入这个 array 执行一个 hash 操作。并且这个 Node array，Node 包含了 key，value，hash，next Node 的引用。想要获取 value 还要 进入 Node，再之后获取 value 的引用，跳转到 value，他们都在内存的不同区域。跳来跳去是不是很烦。<br>还有 hash 碰撞，要做的事更多了。Sparse array 就是用来替代 HashMap 的。在讲之前再说一个优势，内存布局。<br>下面是两个类<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar jol-cli-0.5-full.jar internals java.util.HashMap</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Running 64-bit HotSpot VM.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Objects are 8 bytes aligned.</span></span><br><span class="line">java.util.HashMap object internals:</span><br><span class="line">OFFSET     SIZE     TYPE DESCRIPTION                 VALUE</span><br><span class="line">0         4         (object header)                 01 00 00 00</span><br><span class="line">4         4         (object header)                 00 00 00 00</span><br><span class="line">8         4         (object header)                 9f 37 00 f8</span><br><span class="line">12         4         Set AbstractMap.keySet             null</span><br><span class="line">16         4         Collection AbstractMap.values     null</span><br><span class="line">20         4         int HashMap.size                 0</span><br><span class="line">24         4         int HashMap.modCount             0</span><br><span class="line">28         4         int HashMap.threshold             0</span><br><span class="line">32         4         float HashMap.loadFactor         0.75</span><br><span class="line">36         4         Node[] HashMap.table             null</span><br><span class="line">40         4         Set HashMap.entrySet             null</span><br><span class="line">44         4         (loss due to the next object alignment)</span><br><span class="line"></span><br><span class="line">Instance size: 48 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>一个 HashMap 对象自己要用 48 byte，还不赖。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> java -jar jol-cli-0.5-full.jar internals <span class="string">&#x27;java.util.HashMap$Node&#x27;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Running 64-bit HotSpot VM.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Objects are 8 bytes aligned.</span></span><br><span class="line"></span><br><span class="line">java.util.HashMap$Node object internals:</span><br><span class="line">OFFSET     SIZE     TYPE DESCRIPTION     VALUE</span><br><span class="line">0         12         (object header)     N/A</span><br><span class="line">12         4         int Node.hash         N/A</span><br><span class="line">16         4         Object Node.key     N/A</span><br><span class="line">20         4         Object Node.value     N/A</span><br><span class="line">24         4         Node Node.next         N/A</span><br><span class="line">28         4         (loss due to the next object alignment)</span><br><span class="line"></span><br><span class="line">Instance size: 32 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure>
<p>32 bytes. 数组里的每个元素都这么大，你想想乘上数组 size 要有多大。再然后，HashMap 这东西里边还有个叫负载因子的货，它确保 HashMap 不会被填爆，控制 array 增长，这就导致后边永远是空的。默认负载因子控制 array 只使用 75% 。</p>
<p>现在可以看下 Sparse array 的寻址和内存使用情况了。 Sparse array  同时保存两个数组，一个存 key，一个存 value。与 HashMap 不同，查找 key 时，进行的是二分搜索，直接返回 value 对应的 index，就可以拿到 value 了。数组是连续的，跳转少了很多，没有链表，不必要的东西都没了。但是二分搜索带来的是不稳定的时间复杂度，所以保持这个 map 在一个很小的 size 很重要，几百个差不多，上千的话还是 HashMap 更好。 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> javac SparseArray.java</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> java -cp .:jol-cli-0.5-full.jar org.openjdk.jol.Main \</span></span><br><span class="line"><span class="bash">internals android.util.SparseArray</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Running 64-bit HotSpot VM.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Objects are 8 bytes aligned.</span></span><br><span class="line"></span><br><span class="line">android.util.SparseArray object internals:</span><br><span class="line">OFFSET     SIZE     TYPE DESCRIPTION                 VALUE</span><br><span class="line">0         4         (object header)                 01 00 00 00</span><br><span class="line">4         4         (object header)                 00 00 00 00</span><br><span class="line">8         4         (object header)                 1a 69 01 f8</span><br><span class="line">12         4         int SparseArray.mSize             0</span><br><span class="line">16         1         boolean SparseArray.mGarbage     false</span><br><span class="line">17         3         (alignment/padding gap)         N/A</span><br><span class="line">20         4         int[] SparseArray.mKeys         [0, 0, 0, 0, 0, 0, …]</span><br><span class="line">24         4         Object[] SparseArray.mValues     [null, null, null, …]</span><br><span class="line">28         4         (loss due to the next object alignment)</span><br><span class="line"></span><br><span class="line">Instance size: 32 bytes</span><br><span class="line">Space losses: 3 bytes internal + 4 bytes external = 7 bytes total</span><br></pre></td></tr></table></figure>
<p>JVM 64 bit 和 Android  64 bit 应该差不多，简单看下就好，领会精神。<br>对象大小其实无关紧要，重要的是内部元素。 key 和 value。SparseArray 虽然没有负载因子，但是这些数组是隐式的树，所以实际上也有空置的空间。这里只能将它模糊的描述为和负载因子差不多内存消耗。实际情况取决于你存储的数据形式。列出一个假想的内存消耗计算公式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SparseArray&lt;V&gt;</span><br><span class="line">32 + (4 * entries + 4 * entries) / 0.75</span><br><span class="line"></span><br><span class="line">HashMap&lt;Integer, V&gt;</span><br><span class="line">48 + 32 * entries + 4 * (entries / loadFactor) + 8</span><br></pre></td></tr></table></figure>
<p>一个实例，50 个元素，二分搜索超快<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SparseArray&lt;V&gt;</span><br><span class="line">32 + (4 * 50 + 4 * 50) / 0.75 = 656</span><br><span class="line"></span><br><span class="line">HashMap&lt;Integer, V&gt;</span><br><span class="line">48 + 32 * 50 + 4 * (50 / 0.75) + 8 = 1922</span><br></pre></td></tr></table></figure></p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><ul>
<li>打开 private member inspection 选项</li>
<li>RetroLambda 要用最新版本</li>
<li>试试 Jack (<strong>Ps.</strong> Jack已经挂了) </li>
<li>开启 ProGuard</li>
<li>不要使用 ProGuard 中的 <code>* *</code> 规则，100% 错误的用法</li>
</ul>
<h3 id="Res"><a href="#Res" class="headerlink" title="Res"></a>Res</h3><ul>
<li><a target="_blank" rel="noopener" href="https://source.android.com/source/jack.html">The Jack Toolchain</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/studio/build/shrink-code.html">Proguard</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/orfjackal/retrolambda">Retrolambda</a></li>
<li><a target="_blank" rel="noopener" href="https://jakes.link/eliminate-overhead">Eliminating Code Overhead</a></li>
<li><a target="_blank" rel="noopener" href="http://jakes.link/dex-ed">Dex Ed</a></li>
<li><a target="_blank" rel="noopener" href="http://jakes.link/android-perf">Memories of Android</a></li>
<li><a target="_blank" rel="noopener" href="http://b.android.com/218301">Jack generates extra method for method references</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/orfjackal/retrolambda/issues/81">Retrolambda generates extra method for lambdas / method references</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/JakeWharton/dex-method-list">dex-method-list tool for showing methods in class/jar/aar/dex/apk</a></li>
<li><a target="_blank" rel="noopener" href="http://openjdk.java.net/projects/code-tools/jol/">Java Object Layout (“jol”) tool for showing memory cost of types</a></li>
<li><a target="_blank" rel="noopener" href="http://jakes.link/exploring-scripts">accessors.sh, erased.py, lambdas.sh helper scripts</a></li>
</ul>
<h3 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h3><p><a target="_blank" rel="noopener" href="https://news.realm.io/news/360andev-jake-wharton-java-hidden-costs-android/">https://news.realm.io/news/360andev-jake-wharton-java-hidden-costs-android/</a></p>

  </article>
  <aside class="table-content" id="site-toc">
  <div class="table-content-title">
    <i class="fa fa-arrow-right fa-lg" id="site-toc-hide-btn"></i>
    <span>目录</span>
  </div>
  <div class="table-content-main">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Introduction"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dex-file"><span class="toc-text">Dex file</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-%E5%86%85%E9%83%A8%E7%B1%BB"><span class="toc-text">Java 内部类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#More-Dex"><span class="toc-text">More Dex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%BF%E5%90%8D%E5%86%85%E9%83%A8%E7%B1%BB"><span class="toc-text">匿名内部类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%B0%E5%AE%9E%E4%B8%96%E7%95%8C"><span class="toc-text">现实世界</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Synthetic-%E6%96%B9%E6%B3%95"><span class="toc-text">Synthetic 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Covariant-return-type"><span class="toc-text">Covariant return type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-much-do-these-cost"><span class="toc-text">How much do these cost?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lambdas-in-the-wild"><span class="toc-text">Lambdas in the wild</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Collections"><span class="toc-text">Collections</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Conclusion"><span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Res"><span class="toc-text">Res</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ref"><span class="toc-text">Ref</span></a></li></ol>
  </div>
</aside>
  
    <aside class="passage-copyright">
      <div>本文作者: tiiime</div>
      
        <div>
          原文链接: 
          <a href="" target="_blank">https://invoker.me/java-hidden-costs/</a>
        </div>
      
      <div>
        版权声明: 本博客所有文章除特别声明外, 均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议. 转载请注明出处!
      </div>
    </aside>
  
  
    <div class="passage-tags">
     
      <a href="/tags/java/"><i class="fa fa-tags"></i>java</a>
    
    </div>
  
</div>

    </main>
    
    <div class="site-footer-wrapper">
  <footer class="site-footer">
    
    <div class="site-footer-info">
      <i class="fa fa-clock-o"></i> 本站已稳定运行<span id="site-time"></span>
    </div>
    
      <div class="site-footer-info">
        <i class="fa fa-paw"></i> 您是本站第 <span id="site-count"></span> 位访客
      </div>
    
    
    <div class="site-footer-info">
      <i class="fa fa-copyright"></i> 
      2021 <a href="https://github.com/dongyuanxin/theme-ad/" target="_blank">Theme-AD</a>.
      Created by <a href="https://godbmw.com/" target="_blank">GodBMW</a>.
      All rights reserved.
    </div>
  </footer>
</div>
    <div id="site-layer" style="display:none;">
  <div class="site-layer-content">
    <div class="site-layer-header">
      <span class="site-layer-header-title" id="site-layer-title"></span>
      <i class="fa fa-close" id="site-layer-close"></i>
    </div>
    <div class="site-layer-body" id="site-layer-container">
      <div class="site-layer-input" id="site-layer-search" style="display: none;">
        <div class="site-layer-input-choose">
          <a href="javascript:void(0);" title="Change Search Engine">Google</a>
        </div>
        <input type="text">
        <i class="fa fa-search"></i>
      </div>
      
      <div id="site-layer-welcome" style="display:none;"></div>
    </div>
  </div>
</div>
    

<div class="bottom-bar">
  <div class="bottom-bar-left">
    <a href="/hs-koft/" data-enable="true">
      <i class="fa fa-arrow-left"></i>
    </a>
    <a href="/swift-10days/" data-enable="true">
      <i class="fa fa-arrow-right"></i>
    </a>
  </div>
  <div class="bottom-bar-right">
    <a href="javascript:void(0);" data-enable="true" id="site-toc-show-btn">
      <i class="fa fa-bars"></i>
    </a>
    
    <a href="javascript:void(0);" id="site-toggle-share-btn">
      <i class="fa fa-share-alt"></i>
    </a>
    
    <a href="javascript:void(0);" id="back-top-btn">
      <i class="fa fa-chevron-up"></i>
    </a>
  </div>
</div>
    <div id="share-btn">
  
  
  
  
  
</div>
    
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115942570-1"></script>
  <script async>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-115942570-1');
  </script>






    
  </body>
</html>