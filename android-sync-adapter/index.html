<!DOCTYPE html>
<html>
  
<head>
  <meta charset="utf-8">
  <meta name="author" content="tiiime" />
  
  
  <title>android-sync-adapter | 技不如人，甘拜下风</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="learn,android," />
  

  
  <meta name="description" content="invoker">

  
    <link rel="alternate" href="/atom.xml" title="技不如人，甘拜下风" type="application/atom+xml">
  

  
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.11.1/dist/av-min.js" async></script>
  

  
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
  

  

  

  <script>
  // theme-ad's config script
  // it can be used in every script
  
  window.AD_CONFIG = {
    leancloud: {"appid":"Hyq9wkH495DgNHWhDQCOfQSp-gzGzoHsz","appkey":"WaR7nrzhliHj9aVwdQzkdlGd","comment":false,"count":true},
    welcome: {"enable":false,"interval":30},
    start_time: "2015-01-07",
    passwords: [],
    is_post: true,
    lock: false,
    author: "tiiime",
    share: {"twitter":false,"facebook":false,"weibo":false,"qq":false,"wechat":false},
    mathjax: true,
    page_type: "",
    root: "/"
  };
</script>

  
<script src="/vendor/sha256.min.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/index.js"></script>
<script src="/vendor/qrcode.min.js"></script>


  

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  
<link rel="stylesheet" href="/css/index.css">
<link rel="stylesheet" href="/styles/components/highlight/highlight.css">


  
<meta name="generator" content="Hexo 5.4.0"></head>
  <body>
    <header class="site-header">
  <div class="site-header-brand">
    
      <span class="site-header-brand-title">
        <a href="/">invoker</a>
      </span>
    
    
      <span class="site-header-brand-motto"> | 技不如人，甘拜下风</span>
    
  </div>
  <div class="site-header-right">
    <nav class="site-header-navigation">
      
        <a href="/" target="_self">首页</a>
      
        <a href="/archives/" target="_self">归档</a>
      
        <a href="/tags/" target="_self">标签</a>
      
        <a href="/categories/" target="_self">分类</a>
      
    </nav>
    <div class="site-header-btn">
      
        <a href="https://github.com/tiiime/" target="_blank" id="site-github">
          <i class="fa fa-github-alt"></i>
        </a>
      
      <a href="javascript:void(0);" id="site-search">
        <i class="fa fa-search"></i>
      </a>
      <a href="javascript:void(0);" id="site-nav-btn">
        <i class="fa fa-ellipsis-v"></i>
      </a>
    </div>
  </div>
</header>
<nav class="table-content" id="site-nav">
  <div class="table-content-title">
    <span>导航</span>
  </div>
  <div class="table-content-main">
    <ol class="toc">
      
        <li class="toc-item">
          <a href="/" target="_self">
            首页
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/archives/" target="_self">
            归档
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/tags/" target="_self">
            标签
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/categories/" target="_self">
            分类
          </a>
        </li>
      
    </ol>
  </div>
</nav>
<div id="site-process"></div>
    <main>
      
  <div class="passage">
  <div class="passage-meta">
    <span>
      <i class="fa fa-calendar"></i>2017-10-15
    </span>
    
      <span>
        | <a href="/categories/learn/"><i class="fa fa-bookmark"></i>learn</a>
      </span>
    
  </div>
  <h1 class="passage-title">
    android-sync-adapter
  </h1>
  
  <article class="passage-article">
    <p>SyncAdapter</p>
<hr>
<p>相对于自己实现配置同步的优点：</p>
<ul>
<li><strong>插件架构</strong>，以 callable 组件形式向 system 添加数据传输代码。</li>
<li><strong>自动执行</strong>，可以配置不同的规则自动同步配置，包括数据变化，时间周期或每天指定时间更新。当传输不可用时系统会自动安排重试。</li>
<li><strong>自动网络检查</strong>，当网络可用时才会执行。</li>
<li><strong>电池性能优化</strong></li>
<li><strong>账户管理和权限</strong>，</li>
</ul>
<blockquote>
<p> <strong>Note:</strong> Sync adapters 异步执行，适用于周期高效的数据传输，不适用于即时通信这些队实时性要求高的场景。</p>
</blockquote>
<h3 id="Authenticator"><a href="#Authenticator" class="headerlink" title="Authenticator"></a>Authenticator</h3><p>Sync adapter 框架假定你使用一个帐号登录服务器保存需要在不同设备间传递的数据。所以 sync adapter 需要一个 authenticator 组件，植入 Android 帐号和验证框架，提供标准接口进行用户登录等操作。</p>
<p>即使你的 app 没有用 account，也要提供这个组件。当不需要 account 和 server login 时， 相关认证信息会被忽略，所以你可以只提供一个实现了所有方法的空 authenticator 组件。你还要提供个 bound Service，给 sync adapter 框架调用 authenticator 的方法。</p>
<h4 id="Stub-Authenticator-Component"><a href="#Stub-Authenticator-Component" class="headerlink" title="Stub Authenticator Component"></a>Stub Authenticator Component</h4><p>空 Authenticator 只需要实现方法，返回 null，抛出异常即可。</p>
<p>代码这里有 -&gt; <a target="_blank" rel="noopener" href="https://developer.android.com/training/sync-adapters/creating-authenticator.html#CreateAuthenticatorService">https://developer.android.com/training/sync-adapters/creating-authenticator.html#CreateAuthenticatorService</a></p>
<h4 id="Bind-the-Authenticator-to-the-Framework"><a href="#Bind-the-Authenticator-to-the-Framework" class="headerlink" title="Bind the Authenticator to the Framework"></a>Bind the Authenticator to the Framework</h4><p>Sync adapter framework 需要一个 Service 访问 authenticator。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A bound Service that instantiates the authenticator</span></span><br><span class="line"><span class="comment"> * when started.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticatorService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Instance field that stores the authenticator object</span></span><br><span class="line">    <span class="keyword">private</span> Authenticator mAuthenticator;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Create a new authenticator object</span></span><br><span class="line">        mAuthenticator = <span class="keyword">new</span> Authenticator(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * When the system binds to this Service to make the RPC call</span></span><br><span class="line"><span class="comment">     * return the authenticator&#x27;s IBinder.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mAuthenticator.getIBinder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Add-the-Authenticator-Metadata-File"><a href="#Add-the-Authenticator-Metadata-File" class="headerlink" title="Add the Authenticator Metadata File"></a>Add the Authenticator Metadata File</h4><p>我们还要给 sync adapter 和 account 提供些额外信息，使用 metadata。此文件应位于 <code>/res/xml/</code>  目录下，通常命名为 <code>authenticator.xml</code></p>
<p>具体配置项：</p>
<p><code>android:accountType</code></p>
<p>​    域名形式，用作 sync adapter 内部 identification 的组成部分。对于需要登录的 Server，此字段会被同时发送；不需要登录的服务器也要提供，应该使用你名下的域名，此时不会发送此字段到服务器。</p>
<p><code>android:icon</code></p>
<p><code>android:smallIcon</code></p>
<p><code>android:label</code></p>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example:"></a><strong>Example:</strong></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">account-authenticator</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:accountType</span>=<span class="string">&quot;example.com&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:smallIcon</span>=<span class="string">&quot;@drawable/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="Declare-the-Authenticator-in-the-Manifest"><a href="#Declare-the-Authenticator-in-the-Manifest" class="headerlink" title="Declare the Authenticator in the Manifest"></a>Declare the Authenticator in the Manifest</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:name</span>=<span class="string">&quot;com.example.android.syncadapter.AuthenticatorService&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.accounts.AccountAuthenticator&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:name</span>=<span class="string">&quot;android.accounts.AccountAuthenticator&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:resource</span>=<span class="string">&quot;@xml/authenticator&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Creating-a-Stub-Content-Provider"><a href="#Creating-a-Stub-Content-Provider" class="headerlink" title="Creating a Stub Content Provider"></a>Creating a Stub Content Provider</h3><p>Sync adapter 内部设计由灵活安全的 ContentProvider 提供本地数据管理。所以得写个 ContentProvider。没写的话程序就崩了。</p>
<h5 id="Declare-the-Provider-in-the-Manifest"><a href="#Declare-the-Provider-in-the-Manifest" class="headerlink" title="Declare the Provider in the Manifest"></a>Declare the Provider in the Manifest</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.example.android.network.sync.BasicSyncAdapter&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/AppTheme&quot;</span> &gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.example.android.datasync.provider.StubProvider&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:authorities</span>=<span class="string">&quot;com.example.android.datasync.provider&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:syncable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Creating-a-Sync-Adapter"><a href="#Creating-a-Sync-Adapter" class="headerlink" title="Creating a Sync Adapter"></a>Creating a Sync Adapter</h3><p>Sync adapter 组件内就是你在设备和服务器之间传递数据的 task。Sync adapter framework 会根据你在 app 里提供的 scheduling and triggers  执行你的 sync adapter 组件。</p>
<p>组成部分：</p>
<ul>
<li>Sync adapter class.</li>
<li>Bound Service. </li>
<li>Sync adapter XML metadata file.</li>
<li>Declarations in the app manifest.</li>
</ul>
<h4 id="Extend-the-base-sync-adapter-class-AbstractThreadedSyncAdapter"><a href="#Extend-the-base-sync-adapter-class-AbstractThreadedSyncAdapter" class="headerlink" title="Extend the base sync adapter class AbstractThreadedSyncAdapter"></a>Extend the base sync adapter class AbstractThreadedSyncAdapter</h4><blockquote>
<p><strong>Note:</strong> sync adapter framework 需要 sync adapter 组件是单例形式的。<a target="_blank" rel="noopener" href="https://developer.android.com/training/sync-adapters/creating-sync-adapter.html#CreateSyncAdapterService">Bind the Sync Adapter to the Framework</a> 有更详细内容。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handle the transfer of data between a server and an</span></span><br><span class="line"><span class="comment"> * app, using the Android sync adapter framework.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncAdapter</span> <span class="keyword">extends</span> <span class="title">AbstractThreadedSyncAdapter</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Global variables</span></span><br><span class="line">    <span class="comment">// Define a variable to contain a content resolver instance</span></span><br><span class="line">    ContentResolver mContentResolver;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set up the sync adapter</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SyncAdapter</span><span class="params">(Context context, <span class="keyword">boolean</span> autoInitialize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, autoInitialize);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If your app uses a content resolver, get an instance of it</span></span><br><span class="line"><span class="comment">         * from the incoming Context</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mContentResolver = context.getContentResolver();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set up the sync adapter. This form of the</span></span><br><span class="line"><span class="comment">     * constructor maintains compatibility with Android 3.0</span></span><br><span class="line"><span class="comment">     * and later platform versions</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SyncAdapter</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            Context context,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">boolean</span> autoInitialize,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">boolean</span> allowParallelSyncs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, autoInitialize, allowParallelSyncs);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If your app uses a content resolver, get an instance of it</span></span><br><span class="line"><span class="comment">         * from the incoming Context</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mContentResolver = context.getContentResolver();</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Add-the-data-transfer-code-to-onPerformSync"><a href="#Add-the-data-transfer-code-to-onPerformSync" class="headerlink" title="Add the data transfer code to onPerformSync()"></a>Add the data transfer code to onPerformSync()</h4><p> sync adapter component  只有数据传输部分 task，并不负责启动，sync adapter 框架可以在不启动应用的情况下，后台执行数据传输。当准备得当时，framework 会执行  <code>onPerformSync()</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Specify the code you want to run in the sync adapter. The entire</span></span><br><span class="line"><span class="comment"> * sync adapter runs in a background thread, so you don&#x27;t have to set</span></span><br><span class="line"><span class="comment"> * up your own background processing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPerformSync</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  Account account,</span></span></span><br><span class="line"><span class="params"><span class="function">  Bundle extras,</span></span></span><br><span class="line"><span class="params"><span class="function">  String authority,</span></span></span><br><span class="line"><span class="params"><span class="function">  ContentProviderClient provider,</span></span></span><br><span class="line"><span class="params"><span class="function">  SyncResult syncResult)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Put the data transfer code here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>几个参数：</p>
<ul>
<li><strong>Account</strong>，前面配置的帐号</li>
</ul>
<ul>
<li><strong>Bundle</strong>，触发同步操作时附带的 Bundle 参数。</li>
<li><strong>ContentProviderClient</strong>， 和基本的 <code>ContentResolver</code> 功能一致。用于与 COntentProvider 通讯。</li>
<li><strong>SyncResult</strong>，用于向 sync adapter 反馈同步结果。</li>
</ul>
<blockquote>
<p><strong>Note:</strong> 无需另开线程，默认在后台线程执行。</p>
</blockquote>
<h4 id="Bind-the-Sync-Adapter-to-the-Framework"><a href="#Bind-the-Sync-Adapter-to-the-Framework" class="headerlink" title="Bind the Sync Adapter to the Framework"></a>Bind the Sync Adapter to the Framework</h4><p> 上面完成了同步部分，我们还要让 sync adapter framework 接管我们的 SyncAadapter。需要提供一个可绑定的 Service 再通过一个特殊的 binder 对象将 sync adapter 组件传递给 framework。framework 根据这个 binder 对象调用执行  <code>onPerformSync()</code> 方法传递数据。</p>
<p>在这个 Service 的 <code>onCreate()</code> 方法中创建 sync adapter 组件的单例对象，这样可以将组件的实例化时机延迟到 framework 第一次尝试执行你的 task 时。实例化要考虑线程安全，以防同一 task 多个 sync 操作同时触发时产生问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.android.syncadapter;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define a Service that returns an IBinder for the</span></span><br><span class="line"><span class="comment"> * sync adapter class, allowing the sync adapter framework to call</span></span><br><span class="line"><span class="comment"> * onPerformSync().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Storage for an instance of the sync adapter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SyncAdapter sSyncAdapter = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// Object to use as a thread-safe lock</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object sSyncAdapterLock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Instantiate the sync adapter object.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Create the sync adapter as a singleton.</span></span><br><span class="line"><span class="comment">         * Set the sync adapter as syncable</span></span><br><span class="line"><span class="comment">         * Disallow parallel syncs</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">synchronized</span> (sSyncAdapterLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sSyncAdapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">                sSyncAdapter = <span class="keyword">new</span> SyncAdapter(getApplicationContext(), <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return an object that allows the system to invoke</span></span><br><span class="line"><span class="comment">     * the sync adapter.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Get the object that allows external processes</span></span><br><span class="line"><span class="comment">         * to call onPerformSync(). The object is created</span></span><br><span class="line"><span class="comment">         * in the base class code when the SyncAdapter</span></span><br><span class="line"><span class="comment">         * constructors call super()</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> sSyncAdapter.getSyncAdapterBinder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Sample App</strong>:<a target="_blank" rel="noopener" href="https://github.com/googlesamples/android-BasicSyncAdapter">https://github.com/googlesamples/android-BasicSyncAdapter</a></p>
</blockquote>
<h4 id="Add-the-Account-Required-by-the-Framework"><a href="#Add-the-Account-Required-by-the-Framework" class="headerlink" title="Add the Account Required by the Framework"></a>Add the Account Required by the Framework</h4><p>Framework 要求每个 sync adapter 都要有一个 account type。 在上面  <a target="_blank" rel="noopener" href="https://developer.android.com/training/sync-adapters/creating-authenticator.html#CreateAuthenticatorFile">Add the Authenticator Metadata File</a> 已经介绍了如何声明。现在需要将其设置到 Android System，调用 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/accounts/AccountManager.html#addAccountExplicitly(android.accounts.Account, java.lang.String, android.os.Bundle">addAccountExplicitly()</a>方法。</p>
<p> 最好的位置是启动 Activity 的 onCreate() 方法处：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Constants</span></span><br><span class="line">    <span class="comment">// The authority for the sync adapter&#x27;s content provider</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY = <span class="string">&quot;com.example.android.datasync.provider&quot;</span>;</span><br><span class="line">    <span class="comment">// An account type, in the form of a domain name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCOUNT_TYPE = <span class="string">&quot;example.com&quot;</span>;</span><br><span class="line">    <span class="comment">// The account name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCOUNT = <span class="string">&quot;dummyaccount&quot;</span>;</span><br><span class="line">    <span class="comment">// Instance fields</span></span><br><span class="line">    Account mAccount;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Create the dummy account</span></span><br><span class="line">        mAccount = CreateSyncAccount(<span class="keyword">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new dummy account for the sync adapter</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context The application context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Account <span class="title">CreateSyncAccount</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Create the account type and default account</span></span><br><span class="line">        Account newAccount = <span class="keyword">new</span> Account(</span><br><span class="line">                ACCOUNT, ACCOUNT_TYPE);</span><br><span class="line">        <span class="comment">// Get an instance of the Android account manager</span></span><br><span class="line">        AccountManager accountManager =</span><br><span class="line">                (AccountManager) context.getSystemService(</span><br><span class="line">                        ACCOUNT_SERVICE);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Add the account and account type, no password or user data</span></span><br><span class="line"><span class="comment">         * If successful, return the Account object, otherwise report an error.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (accountManager.addAccountExplicitly(newAccount, <span class="keyword">null</span>, <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * If you don&#x27;t set android:syncable=&quot;true&quot; in</span></span><br><span class="line"><span class="comment">             * in your &lt;provider&gt; element in the manifest,</span></span><br><span class="line"><span class="comment">             * then call context.setIsSyncable(account, AUTHORITY, 1)</span></span><br><span class="line"><span class="comment">             * here.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * The account exists or some other error occurred. Log this, report it,</span></span><br><span class="line"><span class="comment">             * or handle it internally.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Add-the-Sync-Adapter-Metadata-File"><a href="#Add-the-Sync-Adapter-Metadata-File" class="headerlink" title="Add the Sync Adapter Metadata File"></a>Add the Sync Adapter Metadata File</h4><p>提供 sync adapter metadata 文件。位于 <code>/res/xml/</code> 文件夹，通常命名为 <code>syncadapter.xml</code>。</p>
<p>几个属性：</p>
<ul>
<li><code>android:contentAuthority</code> :</li>
<li><code>android:accountType</code> :</li>
<li><code>android:userVisible</code> :默认 account icon 和 label 会在设置的 <strong>Accounts</strong> 项中显示，此项用来控制。即使设置为不可见，你仍可以在 app 中实现自己的 sync adapter 控制界面。</li>
<li><code>android:supportsUploading</code> :允许上传数据，仅下载设置为 false</li>
<li><code>android:allowParallelSyncs</code> :用于多用户，可同时为多个用户同步</li>
<li><code>android:isAlwaysSyncable</code> :标注可在任意时刻执行，如果仅想手动触发，设置为 false，需要同步时手动调用 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentResolver.html#requestSync(android.accounts.Account, java.lang.String, android.os.Bundle">requestSync()</a>) 函数。</li>
</ul>
<p><strong>example:</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sync-adapter</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:contentAuthority</span>=<span class="string">&quot;com.example.android.datasync.provider&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:accountType</span>=<span class="string">&quot;com.android.example.datasync&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:userVisible</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsUploading</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowParallelSyncs</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:isAlwaysSyncable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="Declare-the-Sync-Adapter-in-the-Manifest"><a href="#Declare-the-Sync-Adapter-in-the-Manifest" class="headerlink" title="Declare the Sync Adapter in the Manifest"></a>Declare the Sync Adapter in the Manifest</h4><p>相关权限：</p>
<ul>
<li><code>android.permission.INTERNET</code></li>
<li><code>android.permission.READ_SYNC_SETTINGS</code></li>
<li><code>android.permission.WRITE_SYNC_SETTINGS</code></li>
</ul>
<p><strong>example:</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_SYNC_SETTINGS&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_SYNC_SETTINGS&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;android.permission.AUTHENTICATE_ACCOUNTS&quot;</span>/&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>再用下面这段 xml 将 service 绑定到 framework ：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:name</span>=<span class="string">&quot;com.example.android.datasync.SyncService&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:process</span>=<span class="string">&quot;:sync&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.content.SyncAdapter&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.content.SyncAdapter&quot;</span></span></span><br><span class="line"><span class="tag">    	<span class="attr">android:resource</span>=<span class="string">&quot;@xml/syncadapter&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/service-element.html#exported">android:exported=”true”</a> 允许其他应用(包括 System app)访问</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/service-element.html#proc">android:process=”:sync”</a> tells the system to run the <code>Service</code> in a global shared process named <code>sync</code>，如果你有多个 sync adapter，他们可以共享这个 service， reduces overhead。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/meta-data-element.html"><meta-data></a> <ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/meta-data-element.html#nm">android:name</a> 标识此 meta-data 是供 sync adapter framework 使用的</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/meta-data-element.html#rsrc">android:resource</a> 文件位置</li>
</ul>
</li>
</ul>
<h3 id="Running-a-Sync-Adapter"><a href="#Running-a-Sync-Adapter" class="headerlink" title="Running a Sync Adapter"></a>Running a Sync Adapter</h3><p>上面已经介绍了创建过程，接下来的内容就是如何执行 sync。最开始我们说到可以定时，周期和手动触发执行 sync，我们建议避免通过用户操作直接触发同步，这样就享受不了 sync adapter framework 的好处了。</p>
<p>你可以使用以下形式的 sync：</p>
<ul>
<li>服务器端数据改变： 当服务器下发特定 message 时运行 sync adapter 响应，同步服务端的配置。不会影响性能，也不会浪费电池。</li>
<li>本地数据改变： 可将本地新 config 同步至服务器。使用 ContentProvider 实现起来会容易得多。</li>
<li>定期运行：每隔固定时间运行，或者每天指定时间运行</li>
<li>场景需求：响应用户操作，执行同步</li>
</ul>
<h4 id="Run-the-Sync-Adapter-When-Server-Data-Changes"><a href="#Run-the-Sync-Adapter-When-Server-Data-Changes" class="headerlink" title="Run the Sync Adapter When Server Data Changes"></a>Run the Sync Adapter When Server Data Changes</h4><p>假如你的场景中，服务端的配置经常改变，你可以在数据改变时向终端设备发送特殊消息，客户端接受到消息后调用 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentResolver.html#requestSync(android.accounts.Account, java.lang.String, android.os.Bundle">ContentResolver.requestSync()</a>) 触发 framework 执行 sync task。</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/google/gcm/index.html">Google Cloud Messaging</a>(GCM) 有提供组件方便 Server 端和 Client 端的开发(用不了用不了)。Gcm 收到消息后会发送一个广播，并且只在数据变动时才会触发请求，而周期执行可能会遇到发出请求数据却并没有变动的尴尬。</p>
<p>The following code snippet shows you how to run <code>requestSync()</code> in response to an incoming GCM message:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GcmBroadcastReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Constants</span></span><br><span class="line">    <span class="comment">// Content provider authority</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY = <span class="string">&quot;com.example.android.datasync.provider&quot;</span></span><br><span class="line">    <span class="comment">// Account type</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCOUNT_TYPE = <span class="string">&quot;com.example.android.datasync&quot;</span>;</span><br><span class="line">    <span class="comment">// Account</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCOUNT = <span class="string">&quot;default_account&quot;</span>;</span><br><span class="line">    <span class="comment">// Incoming Intent key for extended data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_SYNC_REQUEST =</span><br><span class="line">            <span class="string">&quot;com.example.android.datasync.KEY_SYNC_REQUEST&quot;</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Get a GCM object instance</span></span><br><span class="line">        GoogleCloudMessaging gcm =</span><br><span class="line">                GoogleCloudMessaging.getInstance(context);</span><br><span class="line">        <span class="comment">// Get the type of GCM message</span></span><br><span class="line">        String messageType = gcm.getMessageType(intent);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Test the message type and examine the message contents.</span></span><br><span class="line"><span class="comment">         * Since GCM is a general-purpose messaging system, you</span></span><br><span class="line"><span class="comment">         * may receive normal messages that don&#x27;t require a sync</span></span><br><span class="line"><span class="comment">         * adapter run.</span></span><br><span class="line"><span class="comment">         * The following code tests for a a boolean flag indicating</span></span><br><span class="line"><span class="comment">         * that the message is requesting a transfer from the device.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (GoogleCloudMessaging.MESSAGE_TYPE_MESSAGE.equals(messageType)</span><br><span class="line">            &amp;&amp;</span><br><span class="line">            intent.getBooleanExtra(KEY_SYNC_REQUEST)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Signal the framework to run your sync adapter. Assume that</span></span><br><span class="line"><span class="comment">             * app initialization has already created the account.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ContentResolver.requestSync(ACCOUNT, AUTHORITY, <span class="keyword">null</span>);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Run-the-Sync-Adapter-When-Content-Provider-Data-Changes"><a href="#Run-the-Sync-Adapter-When-Content-Provider-Data-Changes" class="headerlink" title="Run the Sync Adapter When Content Provider Data Changes"></a>Run the Sync Adapter When Content Provider Data Changes</h4><p>在 ContentProvider 上注册 observer，数据变动时调用 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentResolver.html#requestSync(android.accounts.Account, java.lang.String, android.os.Bundle">requestSync()</a>) 。</p>
<p>主要俩函数</p>
<ul>
<li><code>ContentResolver::registerContentObserver(Uri uri, boolean notifyForDescendants, ContentObserver observer)</code> 注册用</li>
<li><code>ContentResolver::notifyChange(Uri uri, ContentObserver observer)</code> 发送用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Constants</span></span><br><span class="line">    <span class="comment">// Content provider scheme</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCHEME = <span class="string">&quot;content://&quot;</span>;</span><br><span class="line">    <span class="comment">// Content provider authority</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY = <span class="string">&quot;com.example.android.datasync.provider&quot;</span>;</span><br><span class="line">    <span class="comment">// Path for the content provider table</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TABLE_PATH = <span class="string">&quot;data_table&quot;</span>;</span><br><span class="line">    <span class="comment">// Account</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCOUNT = <span class="string">&quot;default_account&quot;</span>;</span><br><span class="line">    <span class="comment">// Global variables</span></span><br><span class="line">    <span class="comment">// A content URI for the content provider&#x27;s data table</span></span><br><span class="line">    Uri mUri;</span><br><span class="line">    <span class="comment">// A content resolver for accessing the provider</span></span><br><span class="line">    ContentResolver mResolver;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableObserver</span> <span class="keyword">extends</span> <span class="title">ContentObserver</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Define a method that&#x27;s called when data in the</span></span><br><span class="line"><span class="comment">         * observed content provider changes.</span></span><br><span class="line"><span class="comment">         * This method signature is provided for compatibility with</span></span><br><span class="line"><span class="comment">         * older platforms.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChange</span><span class="params">(<span class="keyword">boolean</span> selfChange)</span> </span>&#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Invoke the method signature available as of</span></span><br><span class="line"><span class="comment">             * Android platform version 4.1, with a null URI.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            onChange(selfChange, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Define a method that&#x27;s called when data in the</span></span><br><span class="line"><span class="comment">         * observed content provider changes.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChange</span><span class="params">(<span class="keyword">boolean</span> selfChange, Uri changeUri)</span> </span>&#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Ask the framework to run your sync adapter.</span></span><br><span class="line"><span class="comment">             * To maintain backward compatibility, assume that</span></span><br><span class="line"><span class="comment">             * changeUri is null.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ContentResolver.requestSync(ACCOUNT, AUTHORITY, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Get the content resolver object for your app</span></span><br><span class="line">        mResolver = getContentResolver();</span><br><span class="line">        <span class="comment">// Construct a URI that points to the content provider data table</span></span><br><span class="line">        mUri = <span class="keyword">new</span> Uri.Builder()</span><br><span class="line">                  .scheme(SCHEME)</span><br><span class="line">                  .authority(AUTHORITY)</span><br><span class="line">                  .path(TABLE_PATH)</span><br><span class="line">                  .build();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Create a content observer object.</span></span><br><span class="line"><span class="comment">         * Its code does not mutate the provider, so set</span></span><br><span class="line"><span class="comment">         * selfChange to &quot;false&quot;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        TableObserver observer = <span class="keyword">new</span> TableObserver(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Register the observer for the data table. The table&#x27;s path</span></span><br><span class="line"><span class="comment">         * and any of its subpaths trigger the observer.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mResolver.registerContentObserver(mUri, <span class="keyword">true</span>, observer);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Run-the-Sync-Adapter-Periodically"><a href="#Run-the-Sync-Adapter-Periodically" class="headerlink" title="Run the Sync Adapter Periodically"></a>Run the Sync Adapter Periodically</h4><p>周期执行。</p>
<p>注意几点</p>
<ul>
<li>一般会把同步放到晚上，插着充电器时</li>
<li>别太实成把所有设备都设置成同一时间，小心服务器爆炸</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentResolver.html#addPeriodicSync(android.accounts.Account, java.lang.String, android.os.Bundle, long">addPeriodicSync()</a>) 并不指定时间，只设置周期</li>
<li>这样你就不能方便的指定每天固定时间更新了不是</li>
<li>你得用 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/app/AlarmManager.html">AlarmManager</a> 这东西，在指定时间调用这个方法，周期设成 24h</li>
<li>使用 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/app/AlarmManager.html#setInexactRepeating(int, long, long, android.app.PendingIntent">AlarmManager#setInexactRepeating()</a>) 这个方法记得加随机数，参见第二条</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentResolver.html#addPeriodicSync(android.accounts.Account, java.lang.String, android.os.Bundle, long">addPeriodicSync()</a>) 不会关闭 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentResolver.html#setSyncAutomatically(android.accounts.Account, java.lang.String, boolean">setSyncAutomatically()</a>) ，所有有可能段时间内多次执行 sync。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentResolver.html#addPeriodicSync(android.accounts.Account, java.lang.String, android.os.Bundle, long">addPeriodicSync()</a>) 可选的  sync adapter control flags 很少，详情参见文档</li>
<li>感觉很适合天气预报 这种应用啊</li>
<li>再凑一条</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Constants</span></span><br><span class="line">    <span class="comment">// Content provider authority</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY = <span class="string">&quot;com.example.android.datasync.provider&quot;</span>;</span><br><span class="line">    <span class="comment">// Account</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCOUNT = <span class="string">&quot;default_account&quot;</span>;</span><br><span class="line">    <span class="comment">// Sync interval constants</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SECONDS_PER_MINUTE = <span class="number">60L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SYNC_INTERVAL_IN_MINUTES = <span class="number">60L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SYNC_INTERVAL =</span><br><span class="line">            SYNC_INTERVAL_IN_MINUTES *</span><br><span class="line">            SECONDS_PER_MINUTE;</span><br><span class="line">    <span class="comment">// Global variables</span></span><br><span class="line">    <span class="comment">// A content resolver for accessing the provider</span></span><br><span class="line">    ContentResolver mResolver;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Get the content resolver for your app</span></span><br><span class="line">        mResolver = getContentResolver();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Turn on periodic syncing</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ContentResolver.addPeriodicSync(</span><br><span class="line">                ACCOUNT,</span><br><span class="line">                AUTHORITY,</span><br><span class="line">                Bundle.EMPTY,</span><br><span class="line">                SYNC_INTERVAL);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Run-the-Sync-Adapter-On-Demand"><a href="#Run-the-Sync-Adapter-On-Demand" class="headerlink" title="Run the Sync Adapter On Demand"></a>Run the Sync Adapter On Demand</h3><p>原则上这种操作是不可取的，你应该把程序设计为不需要用户进行额外操作(响应用户的号召，让你同步就同步)。</p>
<p>手动调用 <code>ContentResolver.requestSync()</code></p>
<p>flag：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentResolver.html#SYNC_EXTRAS_MANUAL">SYNC_EXTRAS_MANUAL</a> ：强制执行，framework 忽略当前设置， such as the flag set by <code>setSyncAutomatically()</code>.</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/ContentResolver.html#SYNC_EXTRAS_EXPEDITED">SYNC_EXTRAS_EXPEDITED</a> :强制立即执行，不然系统默认会延迟几秒后执行，出于电池方面的一些考虑。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Constants</span></span><br><span class="line">    <span class="comment">// Content provider authority</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY =</span><br><span class="line">            <span class="string">&quot;com.example.android.datasync.provider&quot;</span></span><br><span class="line">    <span class="comment">// Account type</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCOUNT_TYPE = <span class="string">&quot;com.example.android.datasync&quot;</span>;</span><br><span class="line">    <span class="comment">// Account</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCOUNT = <span class="string">&quot;default_account&quot;</span>;</span><br><span class="line">    <span class="comment">// Instance fields</span></span><br><span class="line">    Account mAccount;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Create the dummy account. The code for CreateSyncAccount</span></span><br><span class="line"><span class="comment">         * is listed in the lesson Creating a Sync Adapter</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        mAccount = CreateSyncAccount(<span class="keyword">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Respond to a button click by calling requestSync(). This is an</span></span><br><span class="line"><span class="comment">     * asynchronous operation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This method is attached to the refresh button in the layout</span></span><br><span class="line"><span class="comment">     * XML file</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> v The View associated with the method call,</span></span><br><span class="line"><span class="comment">     * in this case a Button</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRefreshButtonClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Pass the settings flags by inserting them in a bundle</span></span><br><span class="line">        Bundle settingsBundle = <span class="keyword">new</span> Bundle();</span><br><span class="line">        settingsBundle.putBoolean(</span><br><span class="line">                ContentResolver.SYNC_EXTRAS_MANUAL, <span class="keyword">true</span>);</span><br><span class="line">        settingsBundle.putBoolean(</span><br><span class="line">                ContentResolver.SYNC_EXTRAS_EXPEDITED, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Request the sync for the default account, authority, and</span></span><br><span class="line"><span class="comment">         * manual sync settings</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ContentResolver.requestSync(mAccount, AUTHORITY, settingsBundle);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h1><ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/training/sync-adapters/index.html">https://developer.android.com/training/sync-adapters/index.html</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/training/sync-adapters/creating-authenticator.html">https://developer.android.com/training/sync-adapters/creating-authenticator.html</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/accounts/AbstractAccountAuthenticator.html">https://developer.android.com/reference/android/accounts/AbstractAccountAuthenticator.html</a></li>
</ul>

  </article>
  <aside class="table-content" id="site-toc">
  <div class="table-content-title">
    <i class="fa fa-arrow-right fa-lg" id="site-toc-hide-btn"></i>
    <span>目录</span>
  </div>
  <div class="table-content-main">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Authenticator"><span class="toc-text">Authenticator</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stub-Authenticator-Component"><span class="toc-text">Stub Authenticator Component</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Bind-the-Authenticator-to-the-Framework"><span class="toc-text">Bind the Authenticator to the Framework</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Add-the-Authenticator-Metadata-File"><span class="toc-text">Add the Authenticator Metadata File</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Example"><span class="toc-text">Example:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Declare-the-Authenticator-in-the-Manifest"><span class="toc-text">Declare the Authenticator in the Manifest</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-a-Stub-Content-Provider"><span class="toc-text">Creating a Stub Content Provider</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Declare-the-Provider-in-the-Manifest"><span class="toc-text">Declare the Provider in the Manifest</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-a-Sync-Adapter"><span class="toc-text">Creating a Sync Adapter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Extend-the-base-sync-adapter-class-AbstractThreadedSyncAdapter"><span class="toc-text">Extend the base sync adapter class AbstractThreadedSyncAdapter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Add-the-data-transfer-code-to-onPerformSync"><span class="toc-text">Add the data transfer code to onPerformSync()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Bind-the-Sync-Adapter-to-the-Framework"><span class="toc-text">Bind the Sync Adapter to the Framework</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Add-the-Account-Required-by-the-Framework"><span class="toc-text">Add the Account Required by the Framework</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Add-the-Sync-Adapter-Metadata-File"><span class="toc-text">Add the Sync Adapter Metadata File</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Declare-the-Sync-Adapter-in-the-Manifest"><span class="toc-text">Declare the Sync Adapter in the Manifest</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Running-a-Sync-Adapter"><span class="toc-text">Running a Sync Adapter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Run-the-Sync-Adapter-When-Server-Data-Changes"><span class="toc-text">Run the Sync Adapter When Server Data Changes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Run-the-Sync-Adapter-When-Content-Provider-Data-Changes"><span class="toc-text">Run the Sync Adapter When Content Provider Data Changes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Run-the-Sync-Adapter-Periodically"><span class="toc-text">Run the Sync Adapter Periodically</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Run-the-Sync-Adapter-On-Demand"><span class="toc-text">Run the Sync Adapter On Demand</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ref"><span class="toc-text">ref</span></a>
  </div>
</aside>
  
    <aside class="passage-copyright">
      <div>本文作者: tiiime</div>
      
        <div>
          原文链接: 
          <a href="" target="_blank">https://invoker.me/android-sync-adapter/</a>
        </div>
      
      <div>
        版权声明: 本博客所有文章除特别声明外, 均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议. 转载请注明出处!
      </div>
    </aside>
  
  
    <div class="passage-tags">
     
      <a href="/tags/android/"><i class="fa fa-tags"></i>android</a>
    
    </div>
  
</div>

    </main>
    
    <div class="site-footer-wrapper">
  <footer class="site-footer">
    
    <div class="site-footer-info">
      <i class="fa fa-clock-o"></i> 本站已稳定运行<span id="site-time"></span>
    </div>
    
      <div class="site-footer-info">
        <i class="fa fa-paw"></i> 您是本站第 <span id="site-count"></span> 位访客
      </div>
    
    
    <div class="site-footer-info">
      <i class="fa fa-copyright"></i> 
      2021 <a href="https://github.com/dongyuanxin/theme-ad/" target="_blank">Theme-AD</a>.
      Created by <a href="https://godbmw.com/" target="_blank">GodBMW</a>.
      All rights reserved.
    </div>
  </footer>
</div>
    <div id="site-layer" style="display:none;">
  <div class="site-layer-content">
    <div class="site-layer-header">
      <span class="site-layer-header-title" id="site-layer-title"></span>
      <i class="fa fa-close" id="site-layer-close"></i>
    </div>
    <div class="site-layer-body" id="site-layer-container">
      <div class="site-layer-input" id="site-layer-search" style="display: none;">
        <div class="site-layer-input-choose">
          <a href="javascript:void(0);" title="Change Search Engine">Google</a>
        </div>
        <input type="text">
        <i class="fa fa-search"></i>
      </div>
      
      <div id="site-layer-welcome" style="display:none;"></div>
    </div>
  </div>
</div>
    

<div class="bottom-bar">
  <div class="bottom-bar-left">
    <a href="/android-configChanges/" data-enable="true">
      <i class="fa fa-arrow-left"></i>
    </a>
    <a href="/kotlin-coroutines/" data-enable="true">
      <i class="fa fa-arrow-right"></i>
    </a>
  </div>
  <div class="bottom-bar-right">
    <a href="javascript:void(0);" data-enable="true" id="site-toc-show-btn">
      <i class="fa fa-bars"></i>
    </a>
    
    <a href="javascript:void(0);" id="site-toggle-share-btn">
      <i class="fa fa-share-alt"></i>
    </a>
    
    <a href="javascript:void(0);" id="back-top-btn">
      <i class="fa fa-chevron-up"></i>
    </a>
  </div>
</div>
    <div id="share-btn">
  
  
  
  
  
</div>
    
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115942570-1"></script>
  <script async>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-115942570-1');
  </script>






    
  </body>
</html>